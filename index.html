<!-- Shuichi Aizawa 2018 github.com/shu1 -->
<!doctype html>
<html>
<head>
<title>FAANG vs BEEStMoD</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-7050108-4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','UA-7050108-4')</script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(function() {
	var assets = [{
		sy: ["FB","AAPL","AMZN","NFLX","GOOG"],
		fu: "TIME_SERIES_DAILY_ADJUSTED",
		k1: "Time Series (Daily)",
		k2: "5. adjusted close"
	},{
		sy: ["BTC","BCH","ETH","EOS","XLM","XMR","DASH"],
		fu: "DIGITAL_CURRENCY_DAILY",
		k1: "Time Series (Digital Currency Daily)",
		k2: "4b. close (USD)"
	}]

	var params={}, urlParams = location.search.slice(1).split('&');
	for (var i=0; i < urlParams.length; ++i) {
		var pair = urlParams[i].split('=');
		params[pair[0]] = pair[1];
	}
	if (params['date']) {
		startDate = new Date(params['date']);
	}
	if (params['stocks'] || params['crypto']) {
		assets[0].sy = params['stocks'] ? params['stocks'].split(',') : [];
		assets[1].sy = params['crypto'] ? params['crypto'].split(',') : [];
	}

	for (var i=0; i < assets.length; ++i) {
		assets[i].l = 0;
		assets[i].n = 0;
		assets[i].s = -1;
		assets[i].en = 9999;
		assets[i].da = [];
		for (var j=0; j < assets[i].sy.length; ++j) {
			getData(i, j);
		}
	}

	var startDate;
	function getData(index, symbol) {
		var asset = assets[index], request = new XMLHttpRequest();
		request.onload = function() {
			var prevDate, data=[];
			var series = JSON.parse(this.response)[asset.k1];
			for (var i in series) {
				var date = new Date(i);
				if (startDate && startDate > date) break;
				data.push([i, parseFloat(series[i][asset.k2])]);
				prevDate = date;
			}
			if (prevDate && (!startDate || startDate <= prevDate)) {
				startDate = prevDate;
			}
			if (data.length > 0) {
				asset.da[symbol] = data;
				asset.n++;
				if (asset.en > data.length-1) {
					asset.en = data.length-1;
					asset.s = symbol;
				}
			}
			console.log(asset.sy[symbol] + " " + data.length);

			asset.l++;
			if (asset.l == asset.sy.length && asset.n) {
				asset.st = asset.en;
				prepData(index, true);
			}
		}
		request.open('get', "query?function=" + asset.fu + "&symbol=" + asset.sy[symbol] + "&market=USD&apikey=" + (params["apikey"]||btoa(Math.random()).slice(0,16).toUpperCase()));
		request.send();
	}

	function prepData(index, versus) {
		var asset = assets[index], data = asset.da, s = asset.s;
		var prices=[], cols = [{id:'date', label:' ', type:'string'}];
		asset.ti = "";
		for (var i=0; i < data.length; ++i) {
			if (data[i]) {
				cols.push({id:asset.sy[i], label:asset.sy[i], type:'number'});
				asset.ti += asset.sy[i].slice(0,1);
				prices[i] = data[i][asset.st][1];
			}
		}

		if (asset.n == 1) {
			asset.ti = asset.sy[s];
		}
		else if (asset.ti == "BBEEXXD") {
			asset.ti = "BEEStMoD";
		}

		var rows=[], logs=[];
		for (var j = asset.st; j >= 0; --j) {
			var row = [{v: data[s][j][0]}];
			for (var i=0; i < data.length; ++i) {
				if (data[i]) {
					row.push({v: ((data[i][j][1] / prices[i]) - 1) * 100});
					if (data[i][j][0] != data[s][j][0]) {
						logs.push(asset.sy[s] + " " + data[s][j][0] + " " + asset.sy[i] + " " + data[i][j][0]);
					}
				}
			}
			rows.push({c: row});
		}
		if (logs.length > 0) console.error(logs);

		asset.ch = drawChart(cols, rows, asset.ti, asset.ch, index);

		if (versus && assets[0].ti && assets[1].ti) {
			versusStart = assets[0].st;
			prepVersus();
		}
	}

	function prepArray(index, start) {
		var asset = assets[index], data = asset.da, s = asset.s;
		var shares=[];
		for (var i = data.length-1; i >= 0; --i) {
			if (data[i]) {
				shares[i] = 1 / data[i][start][1];
			}
		}

		var array=[], logs=[];
		for (var j = start; j >= 0; --j) {
			var sum=0;
			for (var i=0; i < data.length; ++i) {
				if (data[i]) {
					sum += data[i][j][1] * shares[i];
					if (data[i][j][0] != data[s][j][0]) {
						logs.push(asset.sy[s] + " " + data[s][j][0] + " " + asset.sy[i] + " " + data[i][j][0]);
					}
				}
			}
			array.push([data[s][j][0], ((sum / asset.n) - 1) * 100]);
		}
		if (logs.length > 0) console.error(logs);

		return array;
	}

	var versusStart, versusChart;
	function prepVersus() {
		var date = new Date(assets[0].da[assets[0].s][versusStart][0]);
		var start = assets[1].en;
		while (start > 0 && new Date(assets[1].da[assets[1].s][start][0]) < date) {
			--start;
		}

		var array0 = prepArray(0, versusStart);
		var array1 = prepArray(1, start);
		var cols = [
			{id:'date',	label:' ', type:'string'},
			{id:assets[0].ti, label:assets[0].ti, type:'number'},
			{id:assets[1].ti, label:assets[1].ti, type:'number'}
		];

		var timeout=9999, i=0, j=0, rows=[], logs=[];
		while (timeout-- > 0 && i < array0.length && j < array1.length) {
			if (array0[i][0] == array1[j][0]) {
				rows.push({c:[{v:array0[i][0]}, {v:array0[i][1]}, {v:array1[j][1]}]});
				++i, ++j;
			}
			else if (new Date(array0[i][0]) < new Date(array1[j][0])) {
				++i;
			}
			else if (new Date(array0[i][0]) > new Date(array1[j][0])) {
				++j;
			}
			else {
				logs.push(array0[i][0] + " " + array1[j][0]);
			}
		}
		if (logs.length > 0) console.error(logs);

		versusChart = drawChart(cols, rows, assets[0].ti + " vs " + assets[1].ti, versusChart, 2);
	}

	function drawChart(cols, rows, title, chart, i) {
		if (!chart) {
			var div = document.createElement('div');
			div.tabIndex = i;
			div.style.outline = 'none';
			document.body.appendChild(div);
			chart = new google.visualization.LineChart(div);

			div.addEventListener('wheel', function(event) {
				var dy = event.deltaY > 0 ? 1 : -1;
				if (i < 2 && (dy > 0 && assets[i].st > 0 || dy < 0 && assets[i].st < assets[i].en)) {
					assets[i].st -= dy;
					prepData(i);
				}
				else if (i == 2 && (dy > 0 && versusStart > 0 || dy < 0 && versusStart < assets[0].en)) {
					versusStart -= dy;
					prepVersus();
				}
				event.preventDefault();
			})

			div.addEventListener('keyup', function(event) {
				switch (event.key) {
				case 'ArrowRight':
					if (i < 2 && assets[i].st > 0) {
						assets[i].st--;
						prepData(i);
					}
					else if (i == 2 && versusStart > 0) {
						--versusStart;
						prepVersus();
					}
					break;
				case 'ArrowLeft':
					if (i < 2 && assets[i].st < assets[i].en) {
						assets[i].st++;
						prepData(i);
					}
					else if (i == 2 && versusStart < assets[0].en) {
						++versusStart;
						prepVersus();
					}
					break;
				}
			})
		}

		chart.draw(new google.visualization.DataTable({cols: cols, rows: rows}), {
			title: title,
			width: 1080,
			height: 540
		})
		return chart;
	}
})
</script>
</head>
<body style="width:1080px; margin-left:auto; margin-right:auto"></body>
</html>
