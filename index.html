<!doctype html>
<!-- Shuichi Aizawa 2018 -->
<html>
<head>
<title>FAANG vs BEEStMoD</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-7050108-2"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','UA-7050108-2')</script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
google.charts.load("current", {"packages":["corechart"]});
google.charts.setOnLoadCallback(function() {
	var startDate;
	var assets = [{
		sy: ["FB","AAPL","AMZN","NFLX","GOOG"],
		fu: "TIME_SERIES_DAILY_ADJUSTED",
		k1: "Time Series (Daily)",
		k2: "5. adjusted close",
		ma: ""
	},{
		sy: ["BTC","BCH","ETH","EOS","XLM","XMR","DASH"],
		fu: "DIGITAL_CURRENCY_DAILY",
		k1: "Time Series (Digital Currency Daily)",
		k2: "4b. close (USD)",
		ma: "&market=CNY"
	}]

	var params={}, urlParams = location.search.slice(1).split("&");
	for (var i=0; i < urlParams.length; ++i) {
		var pair = urlParams[i].split("=");
		params[pair[0]] = pair[1];
	}
	if (params["date"]) {
		startDate = new Date(params["date"]);
	}
	if (params["stocks"] || params["crypto"]) {
		assets[0].sy = params["stocks"] ? params["stocks"].split(",") : [];
		assets[1].sy = params["crypto"] ? params["crypto"].split(",") : [];
	}

	for (var i=0; i < assets.length; ++i) {
		assets[i].l=0;
		assets[i].c=-1;
		assets[i].as=[];
		for (var j=0; j < assets[i].sy.length; ++j) {
			getData(assets[i], j);
		}
	}

	function getData(asset, index) {
		var request = new XMLHttpRequest();
		request.onload = function() {
			var prevDate, rows = [];
			var series = JSON.parse(this.response)[asset.k1];
			for (var i in series) {
				var date = new Date(i);
				if (startDate && startDate > date) break;
				rows.push([i, parseFloat(series[i][asset.k2])]);
				prevDate = date;
			}
			if (prevDate && (!startDate || startDate <= prevDate)) {
				startDate = prevDate;
				asset.c = index;
			}
			asset.as[index] = rows;
			console.log(asset.sy[index] + " data: " + rows.length);

			asset.l++;
			if (asset.l == asset.sy.length && asset.c >= 0) {
				prepData(asset);
			}
		};
		request.open("get", "https://www.alphavantage.co/query?function=" + asset.fu + "&symbol=" + asset.sy[index] + asset.ma + "&apikey=" + (params["apikey"]||btoa(Math.random()).slice(0,16).toUpperCase()));
		request.send();
	}

	function prepData(asset) {
		var last = asset.as[asset.c].length-1;
		for (var i=0; i < asset.l; ++i) {
			if (asset.as[i].length > 0) {
				if (last > asset.as[i].length-1) {
					last = asset.as[i].length-1;
					asset.c = i;
				}
				while (last > 0 && new Date(asset.as[i][last][0]) < startDate) {
					--last;
					asset.c = i;
				}
			}
		}

		var num=0, prices=[], shares=[];
		var header = ["Date"];
		asset.ac = "";
		for (var i=0; i < asset.l; ++i) {
			if (asset.as[i].length > 0) {
				header.push(asset.sy[i]);
				asset.ac += asset.sy[i].slice(0,1);
				prices[i] = asset.as[i][last][1];
				shares[i] = 1 / prices[i];
				++num;
			}
		}

		if (num == 1) {
			asset.ac = asset.sy[asset.c];
		}
		else if (asset.ac == "BBEEXXD") {
			asset.ac = "BEEStMoD";
		}

		asset.ar = [];
		var array = [header];
		for (var j = last; j >= 0; --j) {
			var sum=0, row = [asset.as[asset.c][j][0]];
			for (var i=0; i < asset.as.length; ++i) {
				if (asset.as[i].length > 0) {
					var price = asset.as[i][j][1];
					sum += price * shares[i];
					row.push(((price / prices[i]) - 1) * 100);
					if (asset.as[i][j][0] != asset.as[asset.c][j][0]) {
						console.error(asset.sy[asset.c] + " " + asset.as[asset.c][j][0] + " " + asset.sy[i] + " " + asset.as[i][j][0]);
					}
				}
			}
			asset.ar.push([asset.as[asset.c][j][0], ((sum / num) - 1) * 100]);
			array.push(row);
		}

		drawChart(array, asset.ac);

		if (assets[0].l == assets[0].sy.length && assets[1].l == assets[1].sy.length) {
			prepComparison();
		}
	}

	function prepComparison() {
		var header = ["Date"];
		for (var i=0; i < assets.length; ++i) {
			if (assets[i].ac) {
				header.push(assets[i].ac);
			}
		}

		var timeout=2000, array = [header];
		while (--timeout > 0 && assets[0].ar.length && assets[1].ar.length) {
			if (assets[0].ar[0][0] == assets[1].ar[0][0]) {
				array.push([assets[0].ar[0][0], assets[0].ar[0][1], assets[1].ar[0][1]]);
				assets[0].ar.shift();
				assets[1].ar.shift();
			}
			else if (new Date(assets[0].ar[0][0]) < new Date(assets[1].ar[0][0])) {
				assets[0].ar.shift();
			}
			else if (new Date(assets[0].ar[0][0]) > new Date(assets[1].ar[0][0])) {
				assets[1].ar.shift();
			}
			else {
				console.error(assets[0].ar[0][0] + " " + assets[1].ar[0][0]);
			}
		}

		drawChart(array, header[1] + " vs " + header[2]);
	}

	function drawChart(array, title) {
		var div = document.createElement("div");
		document.body.appendChild(div);

		var chart = new google.visualization.LineChart(div);
		chart.draw(google.visualization.arrayToDataTable(array), {
			title: title,
			width:980,
			height:540
		});
	}
});
</script>
</head>
<body style="width:980px;margin-left:auto;margin-right:auto"></body>
</html>
