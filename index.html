<!-- Shuichi Aizawa 2018 github.com/shu1 -->
<!doctype html>
<html>
<head>
<title>FAANG vs BEEStMoD</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-7050108-4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','UA-7050108-4')</script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
google.charts.load("current", {"packages":["corechart"]});
google.charts.setOnLoadCallback(function() {
	var assets = [{
		sy: ["FB","AAPL","AMZN","NFLX","GOOG"],
		fu: "TIME_SERIES_DAILY_ADJUSTED",
		k1: "Time Series (Daily)",
		k2: "5. adjusted close",
		ma: ""
	},{
		sy: ["BTC","BCH","ETH","EOS","XLM","XMR","DASH"],
		fu: "DIGITAL_CURRENCY_DAILY",
		k1: "Time Series (Digital Currency Daily)",
		k2: "4b. close (USD)",
		ma: "&market=CNY"
	}]

	var params={}, urlParams = location.search.slice(1).split("&");
	for (var i=0; i < urlParams.length; ++i) {
		var pair = urlParams[i].split("=");
		params[pair[0]] = pair[1];
	}
	if (params["date"]) {
		startDate = new Date(params["date"]);
	}
	if (params["stocks"] || params["crypto"]) {
		assets[0].sy = params["stocks"] ? params["stocks"].split(",") : [];
		assets[1].sy = params["crypto"] ? params["crypto"].split(",") : [];
	}

	for (var i=0; i < assets.length; ++i) {
		assets[i].l=0;
		assets[i].n=0;
		assets[i].i=-1;
		assets[i].st=9999;
		assets[i].as=[];
		for (var j=0; j < assets[i].sy.length; ++j) {
			getData(assets[i], j);
		}
	}

	var startDate;
	function getData(asset, index) {
		var request = new XMLHttpRequest();
		request.onload = function() {
			var prevDate, rows = [];
			var series = JSON.parse(this.response)[asset.k1];
			for (var i in series) {
				var date = new Date(i);
				if (startDate && startDate > date) break;
				rows.push([i, parseFloat(series[i][asset.k2])]);
				prevDate = date;
			}
			if (prevDate && (!startDate || startDate <= prevDate)) {
				startDate = prevDate;
			}
			if (rows.length > 0) {
				asset.n++;
				asset.as[index] = rows;
				if (asset.st > rows.length-1) {
					asset.st = rows.length-1;
					asset.i = index;
				}
			}
			console.log(asset.sy[index] + " " + rows.length);

			asset.l++;
			if (asset.l == asset.sy.length && asset.n > 0) {
				asset.la = asset.st;
				prepData(asset, true);
			}
		};
		request.open("get", "query?function=" + asset.fu + "&symbol=" + asset.sy[index] + asset.ma + "&market=USD&apikey=" + (params["apikey"]||btoa(Math.random()).slice(0,16).toUpperCase()));
		request.send();
	}

	function prepData(asset, versus, dy) {
		for (var i=0; i < asset.l; ++i) {
			while (asset.as[i] && dy > 0 && asset.la > 0 && new Date(asset.as[i][asset.la][0]) < startDate) {
				asset.la -= dy;
			}
			while (asset.as[i] && dy < 0 && asset.la < asset.st && new Date(asset.as[i][asset.la][0]) > startDate) {
				asset.la -= dy;
			}
		}

		var prices=[], shares=[], header = ["Date"];
		asset.ti = "";
		for (var i=0; i < asset.l; ++i) {
			if (asset.as[i]) {
				header.push(asset.sy[i]);
				asset.ti += asset.sy[i].slice(0,1);
				prices[i] = asset.as[i][asset.la][1];
				shares[i] = 1 / prices[i];
			}
		}

		if (asset.n == 1) {
			asset.ti = asset.sy[asset.i];
		}
		else if (asset.ti == "BBEEXXD") {
			asset.ti = "BEEStMoD";
		}

		asset.ar = [];
		var array = [header], logs=[];
		for (var j = asset.la; j >= 0; --j) {
			var sum=0, row = [asset.as[asset.i][j][0]];
			for (var i=0; i < asset.as.length; ++i) {
				if (asset.as[i]) {
					var price = asset.as[i][j][1];
					sum += price * shares[i];
					row.push(((price / prices[i]) - 1) * 100);
					if (asset.as[i][j][0] != asset.as[asset.i][j][0]) {
						logs.push(asset.sy[asset.i] + " " + asset.as[asset.i][j][0] + " " + asset.sy[i] + " " + asset.as[i][j][0]);
					}
				}
			}
			asset.ar.push([asset.as[asset.i][j][0], ((sum / asset.n) - 1) * 100]);
			array.push(row);
		}
		logs.length > 0 && console.error(logs);

		asset.ch = drawChart(array, asset.ti, asset.ch);

		if (versus && assets[0].l == assets[0].sy.length && assets[1].l == assets[1].sy.length && assets[0].n > 0 && assets[1].n > 0) {
			prepVersus();
		}
	}

	var versusChart;
	function prepVersus() {
		var header = ["Date"];
		for (var i=0; i < assets.length; ++i) {
			if (assets[i].ti) {
				header.push(assets[i].ti);
			}
		}

		var timeout=2000, i=0, j=0, array = [header], logs=[];
		while (--timeout > 0 && i < assets[0].ar.length && j < assets[1].ar.length) {
			if (assets[0].ar[i][0] == assets[1].ar[j][0]) {
				array.push([assets[0].ar[i][0], assets[0].ar[i][1], assets[1].ar[j][1]]);
				++i, ++j;
			}
			else if (new Date(assets[0].ar[i][0]) < new Date(assets[1].ar[j][0])) {
				++i;
			}
			else if (new Date(assets[0].ar[i][0]) > new Date(assets[1].ar[j][0])) {
				++j;
			}
			else {
				logs.push(assets[0].ar[i][0] + " " + assets[1].ar[j][0]);
			}
		}
		logs.length > 0 && console.error(logs);

		versusChart = drawChart(array, header[1] + " vs " + header[2], versusChart);
	}

	function drawChart(array, title, chart) {
		if (!chart) {
			var div = document.createElement("div");
			document.body.appendChild(div);
			chart = new google.visualization.LineChart(div);
		}

		chart.draw(google.visualization.arrayToDataTable(array), {
			title: title,
			width:1080,
			height:540
		});

		return chart;
	}

	keys=[0,0];
	window.addEventListener("keydown", function(event) {
		switch (event.key) {
		case "q":
			if (!keys[0] && !keys[1]) {
				keys[0] = -1;
				zoom(0);
			}
			break;
		case "w":
			if (!keys[0] && !keys[1]) {
				keys[0] = 1;
				zoom(0);
			}
			break;
		case "a":
			if (!keys[0] && !keys[1]) {
				keys[1] = -1;
				zoom(1);
			}
			break;
		case "s":
			if (!keys[0] && !keys[1]) {
				keys[1] = 1;
				zoom(1);
			}
			break;
		}

		function zoom(i) {
			if (assets[i].n > 0 && (keys[i] > 0 && assets[i].la > 0 || keys[i] < 0 && assets[i].la < assets[i].st)) {
				assets[i].la -= keys[i];
				prepData(assets[i]);
				setTimeout(zoom, 100, i);
			}
		}
	});

	window.addEventListener("keyup", function(event) {
		switch (event.key) {
		case "q":
		case "w":
			zoomEnd(0);
			break;
		case "a":
		case "s":
			zoomEnd(1);
			break;
		}

		function zoomEnd(i) {
			if (assets[0].n > 0 && assets[1].n > 0) {
				var asset = assets[i];
				startDate = new Date(asset.as[asset.i][asset.la][0]);
				prepData(assets[1-i], true, keys[i]);
			}
			keys[i] = 0;
		}
	});
});
</script>
</head>
<body style="width:1080px;margin-left:auto;margin-right:auto"></body>
</html>
